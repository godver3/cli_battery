{% extends "base.html" %}

{% block title %}Providers{% endblock %}

{% block content %}
<style>
    .provider-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-top: 20px;
    }

    .provider-card {
        background-color: #444;
        border-radius: 5px;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .provider-name {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 10px;
    }

    .provider-status {
        margin-bottom: 10px;
    }

    .provider-status.active {
        color: #4CAF50;
    }

    .provider-status.inactive {
        color: #f44336;
    }

    .provider-actions {
        margin-top: auto;
    }

    .provider-actions button {
        width: 100%;
        padding: 10px;
        border: none;
        border-radius: 3px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .provider-actions .enable-btn {
        background-color: #4CAF50;
        color: white;
    }

    .provider-actions .disable-btn {
        background-color: #f44336;
        color: white;
    }

    .provider-actions button:hover {
        opacity: 0.9;
    }

    .none-provider {
        background-color: #555;
        color: #fff;
    }

    .provider-actions .disabled-btn {
        background-color: #888;
        color: #ccc;
        cursor: not-allowed;
    }
</style>

<h2>Metadata Providers</h2>

<div class="provider-grid">
    <div class="provider-card none-provider" data-provider="none">
        <div class="provider-name">None</div>
        <div class="provider-status {% if not any_provider_enabled %}active{% else %}inactive{% endif %}">
            Status: {% if not any_provider_enabled %}Active{% else %}Inactive{% endif %}
        </div>
        <div class="provider-actions">
            {% if not any_provider_enabled %}
            <button class="disabled-btn" data-provider="none" disabled>Enabled</button>
            {% else %}
            <button class="enable-btn" data-provider="none">Enable</button>
            {% endif %}
        </div>
    </div>
    {% for provider in providers %}
    <div class="provider-card" data-provider="{{ provider.name }}">
        <div class="provider-name">{{ provider.name|capitalize }}</div>
        <div class="provider-status {% if provider.enabled %}active{% else %}inactive{% endif %}">
            Status: {% if provider.enabled %}Active{% else %}Inactive{% endif %}
        </div>
        <div class="provider-actions">
            {% if provider.name == 'trakt' %}
                {% if trakt_authenticated %}
                    {% if trakt_enabled %}
                    <button class="disabled-btn" disabled>Enabled</button>
                    {% else %}
                    <button class="enable-btn" data-provider="{{ provider.name }}">Enable</button>
                    {% endif %}
                {% else %}
                    <button class="disabled-btn" disabled>Not Authenticated</button>
                {% endif %}
            {% else %}
                {% if provider.enabled %}
                <button class="disable-btn" data-provider="{{ provider.name }}">Disable</button>
                {% else %}
                <button class="enable-btn" data-provider="{{ provider.name }}">Enable</button>
                {% endif %}
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const providerButtons = document.querySelectorAll('.provider-actions button');
    
    function updateProviderUI(providers) {
        const anyProviderEnabled = providers.some(provider => provider.enabled);
        const noneCard = document.querySelector('.provider-card[data-provider="none"]');
        const noneStatus = noneCard.querySelector('.provider-status');
        const noneButton = noneCard.querySelector('.provider-actions button');

        noneStatus.textContent = `Status: ${anyProviderEnabled ? 'Inactive' : 'Active'}`;
        noneStatus.className = `provider-status ${anyProviderEnabled ? 'inactive' : 'active'}`;
        
        if (!anyProviderEnabled) {
            noneButton.textContent = 'Enabled';
            noneButton.className = 'disabled-btn';
            noneButton.disabled = true;
        } else {
            noneButton.textContent = 'Enable';
            noneButton.className = 'enable-btn';
            noneButton.disabled = false;
        }

        providers.forEach(provider => {
            const card = document.querySelector(`.provider-card[data-provider="${provider.name}"]`);
            if (card) {
                const statusDiv = card.querySelector('.provider-status');
                const actionButton = card.querySelector('.provider-actions button');
                
                statusDiv.textContent = `Status: ${provider.enabled ? 'Active' : 'Inactive'}`;
                statusDiv.className = `provider-status ${provider.enabled ? 'active' : 'inactive'}`;
                
                if (provider.name === 'trakt') {
                    if (provider.enabled) {
                        actionButton.textContent = 'Enabled';
                        actionButton.className = 'disabled-btn';
                        actionButton.disabled = true;
                    } else {
                        actionButton.textContent = 'Enable';
                        actionButton.className = 'enable-btn';
                        actionButton.disabled = false;
                    }
                } else {
                    if (provider.enabled) {
                        actionButton.textContent = 'Disable';
                        actionButton.className = 'disable-btn';
                    } else {
                        actionButton.textContent = 'Enable';
                        actionButton.className = 'enable-btn';
                    }
                    actionButton.disabled = false;
                }
            }
        });
    }
    
    providerButtons.forEach(button => {
        button.addEventListener('click', function() {
            const providerName = this.getAttribute('data-provider');
            const action = this.classList.contains('enable-btn') ? 'enable' : 'disable';
            
            fetch('/toggle_provider', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ provider: providerName, action: action })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    updateProviderUI(data.providers);
                } else {
                    alert('Error: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        });
    });
});
</script>
{% endblock %}